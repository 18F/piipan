# Dashboard application

## Prerequisites
- [.NET Core SDK](https://dotnet.microsoft.com/download)

## Local development
To run the app locally:
1. Install the .NET Core SDK development certificate so the app will load over HTTPS ([details](https://docs.microsoft.com/en-us/aspnet/core/security/enforcing-ssl?view=aspnetcore-3.1&tabs=visual-studio#trust-the-aspnet-core-https-development-certificate-on-windows-and-macos)):
```
    dotnet dev-certs https --trust
```
2. Run the app using the `dotnet run` CLI command:
```
    cd dashboard/app
    dotnet run
```
Alternatively, use the `watch` command to update the app upon changes to files:
```
    cd dashboard/app
    dotnet watch run
```
3. Visit https://localhost:5001

## Deployment

### Manual deployment

Running `iac/create-resources.bash` creates an App Service app where the dashboard can be deployed. If the infrastructure has not already been set up, follow the [IaC instructions](iac.md).

When the app is created, Azure automatically sets a remote git URL and issues app-level credentials. You can see these credentials by running `az webapp deployment list-publishing-credentials -n <app_name> -g <resource_group>.

The app's git URL is a little trickier to find. The Azure CLI does not offer a straightforward way of getting this URL, but it can be composed manually by following the steps below.

Start with getting the app's name, as generated by the IaC process:
```
    az webapp list --query "[?starts_with(name,'piipan-dashboard')].name" --output tsv
```

Then, get the app-level deployment user:
```
    az webapp deployment list-publishing-credentials -n <app_name> -g piipan-resources --query publishingUserName --output tsv
```

Finally, set the remote URL on the repo. Since app-level usernames being with a dollar sign, use single quotes or a backslash to escape: 
```
    git remote add azure 'https://<user>@<app_name>.scm.azurewebsites.net/<app_name>.git'
```

With the remote set, push to deploy:
```
    git push azure main
```

### Notes:
- If this is your first time deploying, you'll likely be asked for the password associated with the app-level username. The password can be found either by going to the App Service app in the Azure web portal and then going to Deployment Center > Deployment Credentials or by running the following command:
```
    az webapp deployment list-publishing-credentials -n <app_name> -g piipan-resources --query publishingPassword --output tsv
```
- App Service also allows the use of [user-level credentials](https://docs.microsoft.com/en-us/azure/app-service/deploy-local-git#configure-a-deployment-user). This approach is less friendly with the IaC approach: the user associated with the app will be dependent on the developer who has last run the ARM template that creates the App Service app. For this reason, this approach is not documented here.
- While the entire repo is pushed to Azure, the IaC process configures App Service to run only the app located in `dashboard/app`.